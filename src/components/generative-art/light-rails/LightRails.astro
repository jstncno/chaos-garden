---

---

<div id="art-container"></div>

<style>
  #art-container {
    height: 100%;
    width: 100%;
  }
</style>

<script>
  import P5 from "p5";
  import {
    HSB_COLOR_MAX,
    DEFAULT_TILE_SIZE as TILE_SIZE,
    FRAMES_BETWEEN_LIGHT_PATHS,
    MAX_LIGHT_PATHS,
  } from "@lib/generative-art/light-rails/constants";
  import { LightRailTile } from "@lib/generative-art/light-rails/tile";
  import { WaveFunctionCollapseGridGenerator } from "@lib/generative-art/light-rails/wave-function-collapse";
  import {
    LightPath,
    LightPathGenerator,
  } from "@lib/generative-art/light-rails/light-path";

  const sketch = (p5: P5) => {
    const container = document.getElementById("art-container");
    if (!container) return;

    const { offsetWidth, offsetHeight } = container;
    let numCols: number;
    let numRows: number;
    let pathGen: LightPathGenerator;
    let grid: Array<Array<LightRailTile>> = [];
    let lightPaths: Array<LightPath> = [];
    let frameCount = 0;

    p5.setup = () => {
      const width = Math.floor(offsetWidth / TILE_SIZE) * TILE_SIZE;
      const height = Math.floor(offsetHeight / TILE_SIZE) * TILE_SIZE;

      // Creating and positioning the canvas
      const canvas = p5.createCanvas(offsetWidth, offsetHeight);
      canvas.parent(container);

      numCols = Math.floor(width / TILE_SIZE);
      numRows = Math.floor(height / TILE_SIZE);

      p5.colorMode(p5.HSB, HSB_COLOR_MAX);

      const model = new WaveFunctionCollapseGridGenerator(
        numCols,
        numRows,
        TILE_SIZE,
      );
      model.initialize();
      model.collapse(p5);

      // Initialize grid
      grid = [];
      for (let row = 0; row < model.rows; row++) {
        grid.push([]);
        for (let col = 0; col < model.cols; col++) {
          const data = model.grid[row][col];
          const tile = LightRailTile.fromTile(data);
          grid[row].push(tile);
        }
      }

      pathGen = new LightPathGenerator(grid);
    };

    p5.draw = () => {
      p5.clear();
      p5.background("#283747");

      if (!numCols || !numRows || !grid.length || !pathGen) return;

      for (let row = 0; row < numRows; row++) {
        for (let col = 0; col < numCols; col++) {
          const tile = grid[row][col];
          tile.draw(p5);
        }
      }

      if (
        lightPaths.length < MAX_LIGHT_PATHS &&
        (!lightPaths.length || frameCount > FRAMES_BETWEEN_LIGHT_PATHS)
      ) {
        frameCount = 0;
        const lightPath = pathGen.generate(p5);
        if (lightPath) {
          lightPaths.push(lightPath);
        }
      }

      for (const lightPath of lightPaths) {
        lightPath.draw(p5);
      }

      lightPaths = lightPaths.filter((p) => !p.done);

      frameCount++;
    };
  };

  document.addEventListener("astro:page-load", () => new P5(sketch));

  document.addEventListener("astro:before-swap", () => {
    const container = document.getElementById("art-container");
    container?.remove();
  });
</script>
